# 监控 SDK 全量实现与 Monorepo 迁移实施计划

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 在当前仓库中以 Monorepo + Turborepo 管理方式实现并发布 `@lanlan/monitor-sdk`，包含 Replay（rrweb）、Snapshot（含截图）、IndexedDB 本地持久化与空闲上传、异常/性能/行为/网络监控，全量输出 ESM/CJS/UMD + 类型声明。

**Architecture:** 主线程仅采集并入队，所有计算/压缩/存储/上报在 Worker 完成；Replay 录制用 rrweb，分片传输至 Worker；Snapshot 支持 DOM 快照与可选截图；事件统一模型并落 IndexedDB，空闲时批量上传。

**Tech Stack:** TypeScript, Rollup, pnpm workspaces, Turborepo, rrweb, IndexedDB (idb wrapper or custom), Web Worker.

---

## 方案前置确认

### Task 1: 确认 Monorepo 结构方案与根目录应用位置

**Files:**
- Modify: `README.md`
- Modify: `package.json`

**Step 1: 写出待确认决策清单**
- 是否允许将现有应用移动到 `apps/web`（Turborepo 最佳实践）
- 或接受“轻量 Monorepo”：根目录保留应用，仅新增 `packages/monitor-sdk`

**Step 2: 与用户确认**
- 记录最终选项，用于后续 plan 分支

---

## Monorepo & Turborepo 基础搭建（轻量方案）

### Task 2: 新增 pnpm workspace 配置

**Files:**
- Create: `pnpm-workspace.yaml`

**Step 1: 写入 workspace 定义**
```yaml
packages:
  - "packages/*"
```

**Step 2: 校验根目录依赖管理不变**
- 不改动现有应用依赖

**Step 3: 提交**
```bash
git add pnpm-workspace.yaml
git commit -m "chore: add pnpm workspace"
```

### Task 3: 新增 Turborepo 配置

**Files:**
- Create: `turbo.json`
- Modify: `package.json`

**Step 1: 添加 turbo.json**
```json
{
  "tasks": {
    "build": { "dependsOn": ["^build"], "outputs": ["dist/**"] },
    "lint": {},
    "test": { "dependsOn": ["build"] },
    "dev": { "cache": false, "persistent": true }
  }
}
```

**Step 2: 根 package.json 仅保留 turbo run 调度**
```json
{
  "scripts": {
    "build": "turbo run build",
    "lint": "turbo run lint",
    "test": "turbo run test",
    "dev": "turbo run dev"
  }
}
```

**Step 3: 提交**
```bash
git add turbo.json package.json
git commit -m "chore: add turborepo config"
```

---

## SDK 包结构与基础骨架

### Task 4: 创建 SDK 包目录与基础文件

**Files:**
- Create: `packages/monitor-sdk/package.json`
- Create: `packages/monitor-sdk/tsconfig.json`
- Create: `packages/monitor-sdk/rollup.config.mjs`
- Create: `packages/monitor-sdk/src/index.ts`
- Create: `packages/monitor-sdk/src/core/init.ts`
- Create: `packages/monitor-sdk/src/shared/types.ts`

**Step 1: package.json**
```json
{
  "name": "@lanlan/monitor-sdk",
  "version": "0.1.0",
  "type": "module",
  "main": "dist/index.cjs.js",
  "module": "dist/index.esm.js",
  "unpkg": "dist/index.umd.js",
  "types": "dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.esm.js",
      "require": "./dist/index.cjs.js",
      "default": "./dist/index.umd.js"
    }
  },
  "scripts": {
    "build": "rollup -c",
    "lint": "oxlint",
    "test": "vitest"
  },
  "dependencies": {
    "rrweb": "^2.0.0"
  },
  "devDependencies": {
    "rollup": "^4.0.0",
    "rollup-plugin-dts": "^6.0.0",
    "@rollup/plugin-node-resolve": "^15.0.0",
    "@rollup/plugin-commonjs": "^25.0.0",
    "@rollup/plugin-typescript": "^11.0.0",
    "typescript": "^5.9.0"
  }
}
```

**Step 2: Rollup 配置**
- 输出 ESM/CJS/UMD + d.ts
- UMD 全局变量 `MonitorSDK`

**Step 3: 类型定义基础结构**
- `InitConfig`、`BaseEvent`、`WorkerMessage`、`EventType`

**Step 4: 提交**
```bash
git add packages/monitor-sdk
git commit -m "feat: scaffold monitor sdk package"
```

---

## 事件模型与上下文

### Task 5: 定义统一事件模型与类型字段

**Files:**
- Modify: `packages/monitor-sdk/src/shared/types.ts`

**Step 1: 添加 eventType 字段**
- `eventType` 存储异常类型或统计类型（如 `js_error`, `promise_error`, `resource_error`, `lcp`, `fid`, `cls`, `pv`, `uv`, `stay_duration`）

**Step 2: 添加 page 信息**
- `page.url`、`page.route`（含 query）

**Step 3: 提交**
```bash
git add packages/monitor-sdk/src/shared/types.ts
git commit -m "feat: add unified event model"
```

---

## 主线程核心采集

### Task 6: 实现 Session / User / Page 上下文

**Files:**
- Create: `packages/monitor-sdk/src/core/session.ts`
- Modify: `packages/monitor-sdk/src/core/init.ts`

**Step 1: Session ID 生成与恢复**
- localStorage 维持 sessionId

**Step 2: 页面上下文**
- History API hook + popstate 监听

**Step 3: 提交**
```bash
git add packages/monitor-sdk/src/core
git commit -m "feat: add session and page context"
```

### Task 7: 异常监控

**Files:**
- Create: `packages/monitor-sdk/src/core/hook/error.ts`

**Step 1: 监听 window error / unhandledrejection / 资源加载异常**

**Step 2: 生成 ErrorEvent + eventType**

**Step 3: 提交**
```bash
git add packages/monitor-sdk/src/core/hook/error.ts
git commit -m "feat: add error monitoring"
```

### Task 8: 性能监控

**Files:**
- Create: `packages/monitor-sdk/src/core/hook/performance.ts`

**Step 1: Core Web Vitals (LCP/FID/CLS)**

**Step 2: 其他指标（FP/FCP/首屏等）**

**Step 3: 提交**
```bash
git add packages/monitor-sdk/src/core/hook/performance.ts
git commit -m "feat: add performance monitoring"
```

### Task 9: 行为与 PV/UV/停留

**Files:**
- Create: `packages/monitor-sdk/src/core/tracker/pv.ts`
- Create: `packages/monitor-sdk/src/core/tracker/event.ts`

**Step 1: PV/UV/停留时长**

**Step 2: 点击埋点 + Track API**

**Step 3: 提交**
```bash
git add packages/monitor-sdk/src/core/tracker
git commit -m "feat: add tracker and pv"
```

---

## Worker 与 IndexedDB

### Task 10: Worker 通信与队列

**Files:**
- Create: `packages/monitor-sdk/src/worker/index.ts`
- Create: `packages/monitor-sdk/src/core/queue.ts`

**Step 1: 统一 WorkerMessage 协议**

**Step 2: 主线程仅入队 postMessage**

**Step 3: 提交**
```bash
git add packages/monitor-sdk/src/worker packages/monitor-sdk/src/core/queue.ts
git commit -m "feat: add worker bridge"
```

### Task 11: IndexedDB 存储

**Files:**
- Create: `packages/monitor-sdk/src/worker/storage/idb.ts`
- Create: `packages/monitor-sdk/src/worker/storage/schema.ts`

**Step 1: events_store / snapshot_store / replay_chunk_store / queue_store**

**Step 2: TTL 清理与容量策略**

**Step 3: 提交**
```bash
git add packages/monitor-sdk/src/worker/storage
git commit -m "feat: add indexeddb storage"
```

### Task 12: 空闲上传机制

**Files:**
- Create: `packages/monitor-sdk/src/worker/transport/batch.ts`
- Create: `packages/monitor-sdk/src/worker/transport/beacon.ts`

**Step 1: requestIdleCallback 上传**

**Step 2: offline/online 感知 + 重试**

**Step 3: 提交**
```bash
git add packages/monitor-sdk/src/worker/transport
git commit -m "feat: add idle upload"
```

---

## Snapshot 与 Replay

### Task 13: Snapshot 模块（DOM + 截图）

**Files:**
- Create: `packages/monitor-sdk/src/core/snapshot.ts`
- Create: `packages/monitor-sdk/src/worker/processor/snapshot.ts`

**Step 1: DOM 浅采集**

**Step 2: 截图采集（低分辨率、可配置质量）**

**Step 3: 提交**
```bash
git add packages/monitor-sdk/src/core/snapshot.ts packages/monitor-sdk/src/worker/processor/snapshot.ts
git commit -m "feat: add snapshot with screenshot"
```

### Task 14: Replay 模块（rrweb）

**Files:**
- Create: `packages/monitor-sdk/src/core/replay.ts`
- Create: `packages/monitor-sdk/src/worker/processor/replay.ts`

**Step 1: rrweb 录制与分片**

**Step 2: chunk 持久化 + 上报**

**Step 3: 提交**
```bash
git add packages/monitor-sdk/src/core/replay.ts packages/monitor-sdk/src/worker/processor/replay.ts
git commit -m "feat: add replay with rrweb"
```

---

## 构建与发布

### Task 15: Rollup 多格式 + d.ts 输出

**Files:**
- Modify: `packages/monitor-sdk/rollup.config.mjs`

**Step 1: 输出 ESM/CJS/UMD**

**Step 2: d.ts 输出到 dist/index.d.ts**

**Step 3: 提交**
```bash
git add packages/monitor-sdk/rollup.config.mjs
git commit -m "feat: add rollup builds"
```

### Task 16: NPM 发布验证

**Files:**
- Modify: `packages/monitor-sdk/package.json`

**Step 1: 校验 exports / types 字段**

**Step 2: pnpm pack 预览产物**

**Step 3: 提交**
```bash
git add packages/monitor-sdk/package.json
git commit -m "chore: finalize package metadata"
```

---

## 验证与测试

### Task 17: 基础验证

**Files:**
- Create: `packages/monitor-sdk/tests/smoke.test.ts`

**Step 1: 引入 init 并执行最小初始化**

**Step 2: 验证 worker 通道可用**

**Step 3: 提交**
```bash
git add packages/monitor-sdk/tests/smoke.test.ts
git commit -m "test: add sdk smoke test"
```

---

## 发布流程（手动）

### Task 18: 发布步骤（手动执行）

**Steps:**
1. `pnpm -C packages/monitor-sdk build`
2. `pnpm -C packages/monitor-sdk pack` 检查包内容
3. `pnpm -C packages/monitor-sdk publish --access public`

---

# 执行选项

计划已保存到 `sdk/monitor/总体计划.md`。两种执行方式：

1. **Subagent-Driven（当前会话）** - 我逐步派子任务并在每步后复核
2. **Parallel Session（新会话）** - 新会话使用 executing-plans 逐步执行

请选择 1 或 2。
